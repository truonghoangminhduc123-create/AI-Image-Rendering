<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Render ƒê·ªì H·ªça C·ª±c Cao (Phi√™n b·∫£n ·ªïn ƒë·ªãnh)</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* S·ª≠ d·ª•ng font Inter cho th·∫©m m·ªπ */
        body { font-family: 'Inter', sans-serif; background-color: #1a1a2e; } /* N·ªÅn ƒëen s√¢u */
        
        /* T√πy ch·ªânh spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6366f1; /* M√†u t√≠m */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-input-label {
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-input-label:hover {
            background-color: #4f46e5;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        /* Fixed height for image containers */
        .image-container {
            height: 320px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh */
            width: 100%;
        }
        .image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Gi·ªØ t·ª∑ l·ªá v√† fit v√†o khung */
            border-radius: 4px;
        }
    </style>
    <script>
        // C√°c bi·∫øn to√†n c·ª•c ƒë∆∞·ª£c cung c·∫•p b·ªüi m√¥i tr∆∞·ªùng Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const MODEL_NAME = "gemini-2.5-flash-image-preview"; // T√°ch MODEL_NAME ra ƒë·ªÉ d√πng l·∫°i

        let uploadedBase64 = null;
        let uploadedMimeType = null;
        let renderedImageUrl = null;

        // --- H√ÄM TI·ªÜN √çCH ---

        /**
         * Chuy·ªÉn ƒë·ªïi File sang Base64
         * @param {File} file
         * @returns {Promise<string>} Base64 data string
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Th·ª±c hi·ªán Fetch v·ªõi chi·∫øn l∆∞·ª£c Exponential Backoff ƒë·ªÉ x·ª≠ l√Ω l·ªói m·∫°ng/throttling.
         */
        async function retryFetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Retry attempt ${i + 1} failed with status ${response.status}. Retrying in ${delay.toFixed(0)}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    // ƒê·ªëi v·ªõi c√°c l·ªói kh√°c, tho√°t kh·ªèi v√≤ng l·∫∑p v√† n√©m l·ªói
                    // Th√™m ki·ªÉm tra an to√†n cho response.json()
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                         const errorJson = await response.json();
                         throw new Error(`API Error ${response.status}: ${JSON.stringify(errorJson)}`);
                    } else {
                         const errorText = await response.text();
                         throw new Error(`API Error ${response.status}. Server response was not JSON: ${errorText.substring(0, 100)}...`);
                    }

                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // ƒê·ªëi v·ªõi l·ªói m·∫°ng, th·ª≠ l·∫°i
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Network error during attempt ${i + 1}. Retrying in ${delay.toFixed(0)}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- LOGIC ·ª®NG D·ª§NG ---

        /**
         * C·∫≠p nh·∫≠t tr·∫°ng th√°i t·∫£i v√† c√°c n√∫t
         * @param {boolean} isLoading
         */
        function setLoadingState(isLoading) {
            const startBtn = document.getElementById('startBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            startBtn.disabled = isLoading;
            if (isLoading) {
                startBtn.innerHTML = '<div class="spinner border-white border-t-white/50 w-5 h-5"></div> ƒêang Render...';
                loadingIndicator.classList.remove('hidden');
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('statusMessage').textContent = 'ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn AI...';
            } else {
                startBtn.innerHTML = 'B·∫Øt ƒë·∫ßu Render (Start)';
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * X·ª≠ l√Ω file ·∫£nh ƒë∆∞·ª£c ch·ªçn
         */
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            const originalPreview = document.getElementById('originalPreview');
            const renderedPreview = document.getElementById('renderedPreview');
            const statusMessage = document.getElementById('statusMessage');
            const startBtn = document.getElementById('startBtn');

            if (!file || !file.type.startsWith('image/')) {
                statusMessage.textContent = 'Vui l√≤ng ch·ªçn m·ªôt file ·∫£nh h·ª£p l·ªá.';
                startBtn.disabled = true;
                originalPreview.src = '';
                originalPreview.classList.add('hidden');
                renderedPreview.src = ''; // X√≥a ·∫£nh render c≈©
                renderedPreview.classList.add('hidden');
                return;
            }

            try {
                // Hi·ªÉn th·ªã h√¨nh ·∫£nh g·ªëc
                originalPreview.src = URL.createObjectURL(file);
                // ƒê·∫£m b·∫£o ·∫£nh g·ªëc hi·ªÉn th·ªã ngay
                originalPreview.classList.remove('hidden');

                // X√≥a ·∫£nh render c≈©
                renderedPreview.src = ''; 
                renderedPreview.classList.add('hidden');
                document.getElementById('downloadBtn').disabled = true;

                // Chuy·ªÉn ƒë·ªïi v√† l∆∞u Base64
                uploadedBase64 = await fileToBase64(file);
                uploadedMimeType = file.type;

                statusMessage.textContent = `ƒê√£ t·∫£i l√™n: ${file.name}. S·∫µn s√†ng ƒë·ªÉ Render.`;
                startBtn.disabled = false;
            } catch (error) {
                statusMessage.textContent = 'L·ªói khi ƒë·ªçc file: ' + error.message;
                console.error('L·ªói khi ƒë·ªçc file:', error);
                startBtn.disabled = true;
            }
        }

        /**
         * G·ªçi API Gemini ƒë·ªÉ render l·∫°i h√¨nh ·∫£nh
         */
        async function startRendering() {
            if (!uploadedBase64) {
                document.getElementById('statusMessage').textContent = 'L·ªói: Vui l√≤ng t·∫£i l√™n h√¨nh ·∫£nh tr∆∞·ªõc.';
                return;
            }

            setLoadingState(true);
            const renderedPreview = document.getElementById('renderedPreview');
            
            // ƒê·∫£m b·∫£o ·∫©n ho√†n to√†n v√† x√≥a ngu·ªìn tr∆∞·ªõc khi render m·ªõi
            renderedPreview.src = '';
            renderedPreview.classList.add('hidden');

            // --- ƒê√É LO·∫†I B·ªé KHUNG NH·∫¨P KEY API ---
            // S·ª≠ d·ª•ng chu·ªói r·ªóng ƒë·ªÉ Canvas t·ª± ƒë·ªông inject API Key (theo c·∫•u h√¨nh m√¥i tr∆∞·ªùng)
            const finalApiKey = ""; 
            
            // C·∫•u h√¨nh URL API v·ªõi key
            const API_URL_WITH_KEY = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${finalApiKey}`;


            // C·∫§U H√åNH PROMPT ƒê√É ƒê∆Ø·ª¢C T·ªêI ∆ØU
            const systemInstruction = ""; // B·ªè tr·ªëng
            // Prompt hi·ªán t·∫°i
            const userPrompt = "render l·∫°i h√¨nh n√†y v·ªõi ƒë·ªì h·ªça c·ª±c cao, ko thay ƒë·ªï·ªâ texture, b√≥ng lo√°ng, shadow m·∫°nh"; 

            const payload = {
                contents: [{
                    parts: [
                        { text: userPrompt },
                        {
                            inlineData: {
                                mimeType: uploadedMimeType,
                                data: uploadedBase64
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE'],
                },
                systemInstruction: {
                    parts: [{ text: systemInstruction }] // G·ª≠i chu·ªói r·ªóng
                }
            };

            try {
                const response = await retryFetchWithBackoff(API_URL_WITH_KEY, { // S·ª¨ D·ª§NG API_URL M·ªöI
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // --- KI·ªÇM TRA PH√íNG NG·ª™A L·ªñI (FIX) ---
                if (!response) {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ API sau nhi·ªÅu l·∫ßn th·ª≠ l·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi v√† API Key.");
                }
                // ------------------------------------
                
                const result = await response.json();
                
                // L·∫•y finishReason
                const finishReason = result?.candidates?.[0]?.finishReason;

                // L·∫•y d·ªØ li·ªáu h√¨nh ·∫£nh (inlineData) ƒë·∫ßu ti√™n trong danh s√°ch parts
                const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                const base64Data = imagePart?.inlineData?.data;

                if (!base64Data) {
                    const errorText = JSON.stringify(result, null, 2);
                    
                    let errorMessage = 'L·ªói API: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu h√¨nh ·∫£nh.';
                    
                    if (finishReason === 'NO_IMAGE') {
                        // Th√¥ng b√°o l·ªói chi ti·∫øt cho tr∆∞·ªùng h·ª£p NO_IMAGE
                        errorMessage = 'Render b·ªã ch·∫∑n: AI kh√¥ng t·∫°o h√¨nh ·∫£nh (NO_IMAGE). Th∆∞·ªùng do h√¨nh ·∫£nh g·ªëc ho·∫∑c n·ªôi dung y√™u c·∫ßu vi ph·∫°m ch√≠nh s√°ch an to√†n. Vui l√≤ng th·ª≠ h√¨nh ·∫£nh kh√°c ho·∫∑c thay ƒë·ªïi prompt.';
                    } else {
                        errorMessage += (result?.error?.message ? ` Chi ti·∫øt: ${result.error.message}` : ' L·ªói kh√¥ng x√°c ƒë·ªãnh.');
                    }
                    
                    document.getElementById('statusMessage').textContent = errorMessage;
                    console.error('L·ªói API:', errorText);
                    return;
                }

                renderedImageUrl = `data:image/png;base64,${base64Data}`;
                renderedPreview.src = renderedImageUrl;
                renderedPreview.classList.remove('hidden'); // Hi·ªÉn th·ªã sau khi g√°n ngu·ªìn

                document.getElementById('statusMessage').textContent = 'Render th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ t·∫£i xu·ªëng h√¨nh ·∫£nh.';
                document.getElementById('downloadBtn').disabled = false;

            } catch (error) {
                document.getElementById('statusMessage').textContent = 'L·ªói Render: ' + error.message;
                console.error('L·ªói Render:', error);
            } finally {
                setLoadingState(false);
            }
        }

        /**
         * T·∫£i xu·ªëng h√¨nh ·∫£nh ƒë√£ render
         */
        function downloadImage() {
            if (!renderedImageUrl) {
                document.getElementById('statusMessage').textContent = 'Ch∆∞a c√≥ h√¨nh ·∫£nh n√†o ƒë∆∞·ª£c render ƒë·ªÉ t·∫£i xu·ªëng.';
                return;
            }

            const link = document.createElement('a');
            link.href = renderedImageUrl;
            link.download = `rendered_high_graphics_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            document.getElementById('statusMessage').textContent = 'H√¨nh ·∫£nh ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng.';
        }

        // --- SETUP KHI T·∫¢I TRANG HO√ÄN T·∫§T ---
        window.onload = function() {
            document.getElementById('imageFile').addEventListener('change', handleImageUpload);
            document.getElementById('startBtn').addEventListener('click', startRendering);
            document.getElementById('downloadBtn').addEventListener('click', downloadImage);

            // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu
            setLoadingState(false);
            document.getElementById('startBtn').disabled = true;
            document.getElementById('statusMessage').textContent = 'Vui l√≤ng ch·ªçn h√¨nh ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu.';
        }

    </script>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-gray-800 shadow-2xl shadow-indigo-900/50 rounded-xl p-6 sm:p-8">

        <h1 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">
            üé® AI Render ƒê·ªì H·ªça C·ª±c Cao (Phi√™n b·∫£n ·ªïn ƒë·ªãnh)
        </h1>

        <!-- H∆∞·ªõng d·∫´n Setup cho Canvas/GitHub -->
        <div class="bg-indigo-900/30 p-4 rounded-lg text-sm text-indigo-300 mb-6 border border-indigo-700">
            <p class="font-bold mb-1">‚öôÔ∏è H∆∞·ªõng d·∫´n Setup Key API:</p>
            <p>·ª®ng d·ª•ng n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ ho·∫°t ƒë·ªông trong m√¥i tr∆∞·ªùng **Canvas/Code Editor**.</p>
            <ul class="list-disc list-inside mt-1 ml-2">
                <li>Trong m√¥i tr∆∞·ªùng n√†y, Key API Gemini ƒë∆∞·ª£c **t·ª± ƒë·ªông cung c·∫•p** qua c√°c bi·∫øn m√¥i tr∆∞·ªùng ·∫©n.</li>
                <li>N·∫øu b·∫°n tri·ªÉn khai code n√†y tr√™n c√°c n·ªÅn t·∫£ng kh√°c (v√≠ d·ª•: GitHub Pages), b·∫°n c·∫ßn thi·∫øt l·∫≠p m·ªôt c∆° ch·∫ø ƒë·ªÉ ƒë∆∞a Key API c·ªßa m√¨nh v√†o bi·∫øn `finalApiKey` trong h√†m `startRendering()` ƒë·ªÉ ·ª©ng d·ª•ng ho·∫°t ƒë·ªông.</li>
            </ul>
        </div>

        <!-- Khu v·ª±c ƒëi·ªÅu khi·ªÉn -->
        <div class="space-y-6 mb-8">
            
            <!-- N√∫t Import H√¨nh ·∫¢nh -->
            <div>
                <label for="imageFile" class="file-input-label block w-full text-center bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Import H√¨nh ·∫¢nh (Import Image)
                </label>
                <input type="file" id="imageFile" accept="image/*" class="hidden">
            </div>

            <!-- N√∫t B·∫Øt ƒë·∫ßu Render -->
            <button id="startBtn" onclick="startRendering()" class="w-full flex justify-center items-center bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition duration-300 ease-in-out disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                B·∫Øt ƒë·∫ßu Render (Start)
            </button>
            
            <!-- Th√¥ng b√°o tr·∫°ng th√°i -->
            <div id="statusMessage" class="text-center text-sm font-medium text-indigo-400">
                Vui l√≤ng ch·ªçn h√¨nh ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden flex justify-center py-4">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Khu v·ª±c xem tr∆∞·ªõc v√† t·∫£i xu·ªëng -->
        <div class="grid md:grid-cols-2 gap-6">
            <!-- H√¨nh ·∫£nh G·ªëc -->
            <div class="bg-gray-700 p-4 rounded-lg shadow-inner border border-gray-600">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">H√¨nh ·∫¢nh G·ªëc (Original Image)</h3>
                <div class="image-container flex justify-center items-center rounded-md bg-gray-900/50">
                    <img id="originalPreview" src="" alt="H√¨nh ·∫£nh g·ªëc" class="image-preview hidden">
                </div>
            </div>
            
            <!-- H√¨nh ·∫£nh ƒë√£ Render -->
            <div class="bg-gray-700 p-4 rounded-lg shadow-inner border border-gray-600">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">H√¨nh ·∫¢nh ƒê√£ Render (Rendered Image)</h3>
                <div class="image-container flex justify-center items-center rounded-md bg-gray-900/50">
                    <img id="renderedPreview" src="" alt="H√¨nh ·∫£nh ƒë√£ render" class="image-preview hidden">
                </div>

                <!-- N√∫t T·∫£i Xu·ªëng -->
                <button id="downloadBtn" onclick="downloadImage()" class="mt-4 w-full flex justify-center items-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 12.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    T·∫£i Xu·ªëng (Download)
                </button>
            </div>
        </div>

    </div>
</body>
</html>

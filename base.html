<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI High-Graphics Image Renderer (Stable Version)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use monospace font for the CMD/terminal feel */
        body { font-family: 'monospace'; background-color: #000000; } /* Pure Black background */
        
        /* Default text color is white */
        body, h1, h2, h3, label, option, select, button, #statusMessage {
            color: #FFFFFF;
        }

        /* Custom spinner style */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #FFFFFF; /* White for the spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Black button with white outline */
        .btn-black-outline {
            background-color: #000000;
            border: 1px solid #FFFFFF;
            color: #FFFFFF;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: none;
            transition: all 0.2s;
        }
        .btn-black-outline:hover:not(:disabled) {
            background-color: #333333; /* Slightly gray on hover */
            border-color: #FFFFFF;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); /* White glow effect */
        }
        .btn-black-outline:disabled {
            background-color: #333333;
            border-color: #666666;
            color: #BBBBBB;
            cursor: not-allowed;
        }

        /* Input/Select fields styling */
        .dark-input-select {
            background-color: #000000;
            border: 1px solid #FFFFFF;
            color: #FFFFFF;
            border-radius: 8px;
            padding: 8px 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .dark-input-select:focus {
            outline: none;
            border-color: #AAAAAA;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        /* Fixed height for image containers */
        .image-container {
            height: 320px; /* Fixed height */
            width: 100%;
        }
        .image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Maintain aspect ratio and fit into frame */
            border-radius: 4px;
            border: 1px solid #333333; /* Subtle border for images */
        }

        /* Styling for setup guide section */
        .setup-guide {
            background-color: #111111; /* Dark gray background */
            border: 1px solid #333333; /* Subtle border */
            color: #CCCCCC;
        }
    </style>
    <script>
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const MODEL_NAME = "gemini-2.5-flash-image-preview"; 

        let uploadedBase64 = null;
        let uploadedMimeType = null;
        let renderedImageUrl = null;

        // --- UTILITY FUNCTIONS ---

        /**
         * Converts a File object to a Base64 string
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Executes a fetch request with Exponential Backoff for handling throttling/network errors.
         */
        async function retryFetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Retry attempt ${i + 1} failed with status ${response.status}. Retrying in ${delay.toFixed(0)}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    // Handle other errors
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                         const errorJson = await response.json();
                         throw new Error(`API Error ${response.status}: ${JSON.stringify(errorJson)}`);
                    } else {
                         const errorText = await response.text();
                         throw new Error(`API Error ${response.status}. Server response was not JSON: ${errorText.substring(0, 100)}...`);
                    }

                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // For network errors, retry
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Network error during attempt ${i + 1}. Retrying in ${delay.toFixed(0)}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- APPLICATION LOGIC ---

        /**
         * Updates the loading state and buttons
         */
        function setLoadingState(isLoading) {
            const startBtn = document.getElementById('startBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            startBtn.disabled = isLoading;
            if (isLoading) {
                startBtn.innerHTML = '<div class="spinner w-5 h-5"></div> Rendering...';
                loadingIndicator.classList.remove('hidden');
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('statusMessage').textContent = 'Sending request to AI...';
            } else {
                startBtn.innerHTML = 'Start Rendering';
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Handles the selected image file
         */
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            const originalPreview = document.getElementById('originalPreview');
            const renderedPreview = document.getElementById('renderedPreview');
            const statusMessage = document.getElementById('statusMessage');
            const startBtn = document.getElementById('startBtn');

            if (!file || !file.type.startsWith('image/')) {
                statusMessage.textContent = 'Please select a valid image file.';
                startBtn.disabled = true;
                originalPreview.src = '';
                originalPreview.classList.add('hidden');
                renderedPreview.src = ''; 
                renderedPreview.classList.add('hidden');
                return;
            }

            try {
                // Display original image
                originalPreview.src = URL.createObjectURL(file);
                originalPreview.classList.remove('hidden');

                // Clear previous rendered image
                renderedPreview.src = ''; 
                renderedPreview.classList.add('hidden');
                document.getElementById('downloadBtn').disabled = true;

                // Convert and save Base64
                uploadedBase64 = await fileToBase64(file);
                uploadedMimeType = file.type;

                statusMessage.textContent = `Uploaded: ${file.name}. Ready to Render.`;
                startBtn.disabled = false;
            } catch (error) {
                statusMessage.textContent = 'Error reading file: ' + error.message;
                console.error('Error reading file:', error);
                startBtn.disabled = true;
            }
        }
        
        /**
         * Builds the Prompt based on the selected options
         */
        function buildPrompt() {
            // Existing Options
            const bloom = document.getElementById('bloomSelect').value;
            const time = document.getElementById('timeSelect').value;
            const shadow = document.getElementById('shadowSelect').value;
            const glossiness = document.getElementById('glossinessSelect').value;
            const weather = document.getElementById('weatherSelect').value;
            
            // NEW Options
            const perspective = document.getElementById('perspectiveSelect').value;
            const fidelity = document.getElementById('fidelitySelect').value;
            const color = document.getElementById('colorSelect').value;

            let promptParts = [];
            
            // 1. Core Instruction 
            promptParts.push("Re-render this image with extremely high graphics, high detail, ray tracing, 8K, photorealistic, Unreal Engine 5 quality");

            // 2. Bloom
            if (bloom === 'on') {
                promptParts.push("add bloom effect, intense light flare");
            } else {
                promptParts.push("remove bloom effect");
            }
            
            // 3. Time (Lighting)
            if (time !== 'keep_original') {
                promptParts.push(`change lighting to ${time}`);
            } else {
                 promptParts.push("keep original time of day/lighting");
            }

            // 4. Shadow 
            if (shadow === 'realistic') {
                promptParts.push("soft, realistic shadows, ambient occlusion");
            } else if (shadow === 'strong') {
                promptParts.push("extremely strong shadows, high contrast");
            }

            // 5. Glossiness
            if (glossiness === 'on') {
                promptParts.push("add high gloss, reflective surface (glossy, reflective surface)");
            } else {
                 promptParts.push("matte surface finish");
            }
            
            // 6. Weather
            if (weather !== 'keep_original') {
                promptParts.push(`set the weather context to ${weather}`);
            } else {
                 promptParts.push("keep original weather context");
            }

            // 7. NEW: Perspective (Only add if not keeping original)
            if (perspective !== 'keep_original') {
                promptParts.push(`perspective: ${perspective}`);
            }

            // 8. NEW: Fidelity (Only add if not keeping original)
            if (fidelity !== 'keep_original') {
                promptParts.push(`texture fidelity: ${fidelity}`);
            }
            
            // 9. NEW: Color Grading (Only add if not keeping original)
            if (color !== 'keep_original') {
                promptParts.push(`color grading: ${color}`);
            }


            // Combine all parts into the final prompt
            return promptParts.join(', ');
        }


        /**
         * Calls the Gemini API to re-render the image
         */
        async function startRendering() {
            if (!uploadedBase64) {
                document.getElementById('statusMessage').textContent = 'Error: Please upload an image first.';
                return;
            }

            setLoadingState(true);
            const renderedPreview = document.getElementById('renderedPreview');
            
            // Ensure image is hidden and source is cleared before new render
            renderedPreview.src = '';
            renderedPreview.classList.add('hidden');

            // Use empty string for API Key to let Canvas environment inject it
            const finalApiKey = ""; 
            
            // Configure API URL with key
            const API_URL_WITH_KEY = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${finalApiKey}`;

            // Get custom Prompt
            const userPrompt = buildPrompt();
            console.log("Generated Prompt:", userPrompt);


            const payload = {
                contents: [{
                    parts: [
                        { text: userPrompt },
                        {
                            inlineData: {
                                mimeType: uploadedMimeType,
                                data: uploadedBase64
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE'],
                },
                systemInstruction: {
                    parts: [{ text: "" }] // Empty system instruction part
                }
            };

            try {
                const response = await retryFetchWithBackoff(API_URL_WITH_KEY, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response) {
                    throw new Error("Did not receive a response from the API after multiple retries. Please check your connection.");
                }
                
                const result = await response.json();
                
                // Extract finishReason
                const finishReason = result?.candidates?.[0]?.finishReason;

                // Extract image data (inlineData)
                const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                const base64Data = imagePart?.inlineData?.data;

                if (!base64Data) {
                    const errorText = JSON.stringify(result, null, 2);
                    
                    let errorMessage = 'API Error: Did not receive image data.';
                    
                    if (finishReason === 'NO_IMAGE') {
                        // Detailed error for NO_IMAGE
                        errorMessage = 'Render Blocked: AI did not generate an image (NO_IMAGE). This usually happens when the original image or the request content violates safety policies. Please try a different image or modify the prompt.';
                    } else {
                        errorMessage += (result?.error?.message ? ` Details: ${result.error.message}` : ' Unknown error.');
                    }
                    
                    document.getElementById('statusMessage').textContent = errorMessage;
                    console.error('API Error:', errorText);
                    return;
                }

                renderedImageUrl = `data:image/png;base64,${base64Data}`;
                renderedPreview.src = renderedImageUrl;
                renderedPreview.classList.remove('hidden'); // Show after source is set

                document.getElementById('statusMessage').textContent = 'Render successful! You can now download the image.';
                document.getElementById('downloadBtn').disabled = false;

            } catch (error) {
                document.getElementById('statusMessage').textContent = 'Render Error: ' + error.message;
                console.error('Render Error:', error);
            } finally {
                setLoadingState(false);
            }
        }

        /**
         * Downloads the rendered image
         */
        function downloadImage() {
            if (!renderedImageUrl) {
                document.getElementById('statusMessage').textContent = 'No image has been rendered to download.';
                return;
            }

            const link = document.createElement('a');
            link.href = renderedImageUrl;
            link.download = `rendered_custom_graphics_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            document.getElementById('statusMessage').textContent = 'Image downloaded.';
        }

        // --- SETUP ON PAGE LOAD ---
        window.onload = function() {
            document.getElementById('imageFile').addEventListener('change', handleImageUpload);
            document.getElementById('startBtn').addEventListener('click', startRendering);
            document.getElementById('downloadBtn').addEventListener('click', downloadImage);

            // Initial state setup
            setLoadingState(false);
            document.getElementById('startBtn').disabled = true;
            document.getElementById('statusMessage').textContent = 'Please select an image to begin.';
        }

    </script>
</head>
<body class="bg-black min-h-screen p-4 sm:p-8 text-white">

    <div class="max-w-4xl mx-auto bg-black shadow-none rounded-none p-6 sm:p-8 border border-white">

        <h1 class="text-3xl font-bold mb-6 border-b border-white pb-2">
            AI Custom High-Graphics Renderer
        </h1>

        <!-- Setup Guide Section -->
        <div class="setup-guide p-4 rounded-lg text-sm mb-6">
            <p class="font-bold mb-1">⚙️ API Key Setup Guide:</p>
            <p>This application is designed to operate within the **Canvas/Code Editor** environment.</p>
            <ul class="list-disc list-inside mt-1 ml-2">
                <li>In this environment, the Gemini API Key is **automatically provided** via hidden environment variables.</li>
                <li>If you deploy this code on other platforms (e.g., GitHub Pages), you need to set up a mechanism to inject your API Key into the `finalApiKey` variable in the `startRendering()` function for the application to work.</li>
            </ul>
        </div>

        <!-- Configuration Settings Section -->
        <div class="space-y-4 mb-6">
            <h2 class="text-xl font-semibold">⚙️ Configuration Settings</h2>
            
            <!-- ROW 1: General Graphics -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                
                <!-- Bloom Option -->
                <div>
                    <label for="bloomSelect" class="block text-sm font-medium mb-1">Bloom (Glow/Light)</label>
                    <select id="bloomSelect" class="dark-input-select">
                        <option value="on">On</option>
                        <option value="off" selected>Off</option>
                    </select>
                </div>

                <!-- Time Option -->
                <div>
                    <label for="timeSelect" class="block text-sm font-medium mb-1">Time (Lighting)</label>
                    <select id="timeSelect" class="dark-input-select">
                        <option value="keep_original" selected>Keep Original</option>
                        <option value="morning sunlight (golden hour)">Morning (Golden Hour)</option>
                        <option value="midday sun">Midday Sun</option>
                        <option value="afternoon sunlight (sunset)">Afternoon (Sunset)</option>
                        <option value="nighttime, neon lighting">Nighttime (Neon Lighting)</option>
                    </select>
                </div>
                
                <!-- Shadow Option -->
                <div>
                    <label for="shadowSelect" class="block text-sm font-medium mb-1">Shadow (Depth)</label>
                    <select id="shadowSelect" class="dark-input-select">
                        <option value="realistic" selected>Realistic</option>
                        <option value="strong">Strong Contrast</option>
                    </select>
                </div>
                
                <!-- Glossiness Option -->
                <div>
                    <label for="glossinessSelect" class="block text-sm font-medium mb-1">Glossiness (Reflectivity)</label>
                    <select id="glossinessSelect" class="dark-input-select">
                        <option value="on">On</option>
                        <option value="off" selected>Off</option>
                    </select>
                </div>

                <!-- Weather Option -->
                <div>
                    <label for="weatherSelect" class="block text-sm font-medium mb-1">Weather (Atmosphere)</label>
                    <select id="weatherSelect" class="dark-input-select">
                        <option value="keep_original" selected>Keep Original</option>
                        <option value="sunny and clear sky">Sunny and Clear</option>
                        <option value="heavy rain and dark clouds">Heavy Rain</option>
                        <option value="snowing and cold weather">Snowing</option>
                        <option value="heavy fog and mysterious atmosphere">Heavy Fog</option>
                    </select>
                </div>

            </div>
            
            <!-- ROW 2: Advanced Style/Mood -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-4 border-t border-white/50">
                
                <!-- NEW: Perspective Option -->
                <div>
                    <label for="perspectiveSelect" class="block text-sm font-medium mb-1">Perspective (Camera Angle)</label>
                    <select id="perspectiveSelect" class="dark-input-select">
                        <option value="keep_original" selected>Keep Original</option>
                        <option value="cinematic, dramatic lighting">Cinematic (Dramatic)</option>
                        <option value="low angle shot, looking up">Low Angle (Looking Up)</option>
                        <option value="wide panoramic shot">Wide Panoramic Shot</option>
                        <option value="close up macro shot">Close-up Macro Shot</option>
                    </select>
                </div>

                <!-- NEW: Fidelity Option -->
                <div>
                    <label for="fidelitySelect" class="block text-sm font-medium mb-1">Texture Fidelity (Detail)</label>
                    <select id="fidelitySelect" class="dark-input-select">
                        <option value="keep_original" selected>Keep Original</option>
                        <option value="PBR, highly detailed texture mapping">PBR (High Detail)</option>
                        <option value="gritty, worn texture, scratches">Gritty (Worn Texture)</option>
                        <option value="smooth, stylized, vibrant cartoon texture">Stylized (Vibrant)</option>
                    </select>
                </div>

                <!-- NEW: Color Grading Option -->
                <div>
                    <label for="colorSelect" class="block text-sm font-medium mb-1">Color Grade (Mood)</label>
                    <select id="colorSelect" class="dark-input-select">
                        <option value="keep_original" selected>Keep Original</option>
                        <option value="vibrant, high saturation">Vibrant (High Saturation)</option>
                        <option value="dark, monochromatic, film noir">Film Noir (Dark/Mono)</option>
                        <option value="neon glow, cyberpunk aesthetic">Neon Glow (Cyberpunk)</option>
                        <option value="vintage, sepia tone">Vintage (Sepia Tone)</option>
                    </select>
                </div>

            </div>
        </div>

        <!-- Action Controls Section -->
        <div class="space-y-6 mb-8">
            
            <!-- Image Import Button -->
            <div>
                <label for="imageFile" class="btn-black-outline block w-full text-center cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Import Image
                </label>
                <input type="file" id="imageFile" accept="image/*" class="hidden">
            </div>

            <!-- Start Render Button -->
            <button id="startBtn" onclick="startRendering()" class="btn-black-outline w-full" disabled>
                Start Rendering
            </button>
            
            <!-- Status Message -->
            <div id="statusMessage" class="text-center text-sm font-medium text-white-400">
                Please select an image to begin.
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden flex justify-center py-4">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Preview and Download Section -->
        <div class="grid md:grid-cols-2 gap-6">
            
            <!-- Original Image -->
            <div class="bg-black p-4 rounded-lg border border-white">
                <h3 class="text-lg font-semibold mb-3">Original Image</h3>
                <div class="image-container flex justify-center items-center rounded-md bg-black/50">
                    <img id="originalPreview" src="" alt="Original image preview" class="image-preview hidden">
                </div>
            </div>
            
            <!-- Rendered Image -->
            <div class="bg-black p-4 rounded-lg border border-white">
                <h3 class="text-lg font-semibold mb-3">Rendered Image</h3>
                <div class="image-container flex justify-center items-center rounded-md bg-black/50">
                    <img id="renderedPreview" src="" alt="Rendered image preview" class="image-preview hidden">
                </div>

                <!-- Download Button -->
                <button id="downloadBtn" onclick="downloadImage()" class="btn-black-outline mt-4 w-full" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 12.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download
                </button>
            </div>
        </div>

    </div>
</body>
</html>
